"use strict";(self.webpackChunkhandbook=self.webpackChunkhandbook||[]).push([[5183],{4137:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),m=p(n),u=i,c=m["".concat(s,".").concat(u)]||m[u]||h[u]||o;return n?a.createElement(c,r(r({ref:t},d),{},{components:n})):a.createElement(c,r({ref:t},d))}));function u(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8109:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var a=n(7462),i=(n(7294),n(4137));const o={title:"Tutorial: Create a schema"},r=void 0,l={unversionedId:"tutorials/send-to-node",id:"tutorials/send-to-node",title:"Tutorial: Create a schema",description:"In this tutorial we want to register a new schema on a p2panda node and create our first document with it! We will use the send-to-node command line tool and aquadoggo node for this.",source:"@site/docs/tutorials/send-to-node.md",sourceDirName:"tutorials",slug:"/tutorials/send-to-node",permalink:"/tutorials/send-to-node",draft:!1,tags:[],version:"current",frontMatter:{title:"Tutorial: Create a schema"}},s={},p=[{value:"What do I need?",id:"what-do-i-need",level:2},{value:"What is <code>send-to-node</code>?",id:"what-is-send-to-node",level:2},{value:"How does it work?",id:"how-does-it-work",level:3},{value:"Install <code>send-to-node</code>",id:"install-send-to-node",level:3},{value:"Start node",id:"start-node",level:2},{value:"Create a schema",id:"create-a-schema",level:2},{value:"Create <code>message</code> field",id:"create-message-field",level:3},{value:"What is an operation?",id:"what-is-an-operation",level:4},{value:"Send to node",id:"send-to-node",level:4},{value:"Query the field",id:"query-the-field",level:4},{value:"Create <code>timestamp</code> field",id:"create-timestamp-field",level:3},{value:"Create <code>chat</code> schema",id:"create-chat-schema",level:3},{value:"Create a new chat message!",id:"create-a-new-chat-message",level:2},{value:"Update chat message",id:"update-chat-message",level:2},{value:"Delete chat message",id:"delete-chat-message",level:2},{value:"Done!",id:"done",level:2}],d={toc:p};function h(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"In this tutorial we want to register a new schema on a p2panda node and create our first document with it! We will use the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/p2panda/send-to-node"},(0,i.kt)("inlineCode",{parentName:"a"},"send-to-node"))," command line tool and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/p2panda/aquadoggo"},(0,i.kt)("inlineCode",{parentName:"a"},"aquadoggo"))," node for this."),(0,i.kt)("h2",{id:"what-do-i-need"},"What do I need?"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Rust"),(0,i.kt)("li",{parentName:"ul"},"Editor"),(0,i.kt)("li",{parentName:"ul"},"Terminal"),(0,i.kt)("li",{parentName:"ul"},"Browser")),(0,i.kt)("admonition",{title:"Never worked with Rust before?",type:"info"},(0,i.kt)("p",{parentName:"admonition"},"This tutorial requires you to have a working Rust environment. If you have never worked with Rust before this is no problem! Setting it up is fairly easy and besides using some basic command line commands there is no more Rust knowledge required to make the node run on your computer.")),(0,i.kt)("details",null,(0,i.kt)("summary",null,"How do I install Rust?"),(0,i.kt)("p",null,"Make sure you have a working Rust environment installed on your computer before you begin with the tutorial. You can check this by running ",(0,i.kt)("inlineCode",{parentName:"p"},"rustc --version")," in your terminal. This tutorial was written with Rust version ",(0,i.kt)("inlineCode",{parentName:"p"},"1.63.0")," but it will probably also work with other versions."),(0,i.kt)("p",null,"If you don't have Rust installed yet you can follow the steps on the official Rust website: ",(0,i.kt)("a",{parentName:"p",href:"https://www.rust-lang.org/tools/install"},"How to install Rust"),".")),(0,i.kt)("h2",{id:"what-is-send-to-node"},"What is ",(0,i.kt)("inlineCode",{parentName:"h2"},"send-to-node"),"?"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," is the most minimal program to send data to an p2panda node. It takes the data you want to send, signs it with a private key and sends it to the node via GraphQL. It is great for doing very ",(0,i.kt)("em",{parentName:"p"},"basic")," things with p2panda, especially if you want to learn how everything works!"),(0,i.kt)("admonition",{title:"More tools",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"In the future you will probably not do ",(0,i.kt)("em",{parentName:"p"},"everything")," with ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," as it is may be even too minimal and therefore tedious to do more involved tasks, like creating complex schemas. But for learning, testing and understanding it is really great.")),(0,i.kt)("h3",{id:"how-does-it-work"},"How does it work?"),(0,i.kt)("p",null,"Let's have a quick look at the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/p2panda/send-to-node/blob/main/src/main.rs"},"source code of ",(0,i.kt)("inlineCode",{parentName:"a"},"send-to-node")),". You will notice that it is a fairly small program where most of the code is about parsing user input and preparing everything we need to make GraphQL queries."),(0,i.kt)("p",null,"Let's look at the interesting bits! The program .."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Checks if a file with a private key inside exists (encoded as a hexadecimal string). The default path is ",(0,i.kt)("inlineCode",{parentName:"li"},"key.txt"),". If it exists, we derive the key pair from it, if it doesn't, we generate a new key pair and store it under that path."),(0,i.kt)("li",{parentName:"ol"},"Reads a JSON-formatted string from ",(0,i.kt)("em",{parentName:"li"},"stdin")," which gets deserialized into a p2panda operation. Operations are the actual data we send around in the network."),(0,i.kt)("li",{parentName:"ol"},"Makes a ",(0,i.kt)("inlineCode",{parentName:"li"},"nextArgs")," GraphQL query to retreive the latest information from the node we need to create our next entry. You can ",(0,i.kt)("a",{parentName:"li",href:"/learn/entries"},"read more about entries")," in our learn section."),(0,i.kt)("li",{parentName:"ol"},"Takes the required informations (like ",(0,i.kt)("inlineCode",{parentName:"li"},"seqNum"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"logId"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"backlink")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"skiplink"),") to encode the operation and entry"),(0,i.kt)("li",{parentName:"ol"},"Signs the entry with the given key pair"),(0,i.kt)("li",{parentName:"ol"},"Sends the encoded and signed data to the node using the ",(0,i.kt)("inlineCode",{parentName:"li"},"publish")," GraphQL mutation!")),(0,i.kt)("admonition",{title:"Re-Write it in JavaScript!",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"A fun exercise could be to try implement ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," in JavaScript with the ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/p2panda-js"},(0,i.kt)("inlineCode",{parentName:"a"},"p2panda-js"))," package.")),(0,i.kt)("admonition",{title:"Why JSON?",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"p2panda does not use JSON internally, even though ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," works with ",(0,i.kt)("inlineCode",{parentName:"p"},".json")," files. It is just the choosen format for this program to create operations. Internally all operations are actually encoded as ",(0,i.kt)("a",{parentName:"p",href:"/specification/data-types/operations/#encoding-format"},"CBOR"),".")),(0,i.kt)("h3",{id:"install-send-to-node"},"Install ",(0,i.kt)("inlineCode",{parentName:"h3"},"send-to-node")),(0,i.kt)("p",null,"Run the following commands in your terminal if you haven't installed ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," yet. It is a Rust program you can compile on your computer:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# Clone the `send-to-node` git repository\ngit clone https://github.com/p2panda/send-to-node.git\n\n# Move into the folder you've just created\ncd send-to-node\n\n# Compile and run to test it\ncargo run -- --help\n")),(0,i.kt)("p",null,"Compiling ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," might take a couple of seconds in the beginning, but next time it will start directly."),(0,i.kt)("h2",{id:"start-node"},"Start node"),(0,i.kt)("p",null,"We want to send data to a node, but for this we need a node first! You can follow the ",(0,i.kt)("a",{parentName:"p",href:"/tutorials/aquadoggo"},"Set up a local node")," to learn how to do this in detail, or just run the following steps here:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# Clone the `aquadoggo` git repository\ngit clone https://github.com/p2panda/aquadoggo.git\n\n# Move into the folder you've just created\ncd aquadoggo\n\n# Compile and start the node with basic logging enabled\nRUST_LOG=aquadoggo=info cargo run\n")),(0,i.kt)("p",null,"Now you have a local node running on port ",(0,i.kt)("inlineCode",{parentName:"p"},"2020"),". You can check if everything is alright by opening your browser and surfing to ",(0,i.kt)("a",{parentName:"p",href:"http://localhost:2020/graphql"},"http://localhost:2020/graphql"),", do you see the GraphQL playground? Super. Let's play with it soon!"),(0,i.kt)("h2",{id:"create-a-schema"},"Create a schema"),(0,i.kt)("p",null,"We want to register a new schema on the node now, this means that the node we've just started will learn about a new data type which can then be used inside the p2panda network. This is the starting point for building an application!"),(0,i.kt)("p",null,"But what application do we want to build? Let's try a chat where we can send messages! Every message should contain a ",(0,i.kt)("strong",{parentName:"p"},"plain text string")," and a ",(0,i.kt)("strong",{parentName:"p"},"timestamp")," indicating when it was sent."),(0,i.kt)("admonition",{title:"Time is funny",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Timestamps in p2p applications are interesting. Check out the ",(0,i.kt)("a",{parentName:"p",href:"/learn/entries"},"Entry")," section to learn more about it.")),(0,i.kt)("p",null,"To do this we need to send three operations: "),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"One operation creating the ",(0,i.kt)("inlineCode",{parentName:"li"},"message")," field"),(0,i.kt)("li",{parentName:"ol"},"One operation creating the ",(0,i.kt)("inlineCode",{parentName:"li"},"timestamp")," field"),(0,i.kt)("li",{parentName:"ol"},"One operation to finally create the ",(0,i.kt)("inlineCode",{parentName:"li"},"chat")," schema which contains both of these fields")),(0,i.kt)("admonition",{title:"Schemas are only created once",type:"note"},(0,i.kt)("p",{parentName:"admonition"},'Creating a schema only happens once! Afterwards you and others can just use it, they do not need to "register" it again or anything, but other nodes can simply just replicate the data from your node to also receive the schema you\'ve created.')),(0,i.kt)("p",null,"All the next steps will take place inside the ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," directory you downloaded via git. Make sure you are in that folder in your terminal!"),(0,i.kt)("h3",{id:"create-message-field"},"Create ",(0,i.kt)("inlineCode",{parentName:"h3"},"message")," field"),(0,i.kt)("p",null,"As already mentioned, ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," requires us to format the data we want to send in JSON. In a text editor of your choice we can write our first operation into a file named ",(0,i.kt)("inlineCode",{parentName:"p"},"001-message-field.json"),":"),(0,i.kt)("admonition",{title:"Naming",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The filename does not matter to ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node"),", but it can be helpful to give it a meaningful name for you plus some sort of numbering system to indicate that these operations should be created in that order.")),(0,i.kt)("p",null,"Insert the following content into the ",(0,i.kt)("inlineCode",{parentName:"p"},"001-message-field.json")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[1, 0, "schema_field_definition_v1", { "name": "message", "type": "str" }]\n')),(0,i.kt)("h4",{id:"what-is-an-operation"},"What is an operation?"),(0,i.kt)("p",null,"What does all of this mean? We look at an array with four fields inside. Let's go through all of them from left to right."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Version")),(0,i.kt)("p",null,"The first field with the value ",(0,i.kt)("inlineCode",{parentName:"p"},"1")," indicates the version we're using to write this operation. For now it will probably stay ",(0,i.kt)("inlineCode",{parentName:"p"},"1")," for a longer time until there are any important updates to the p2panda ",(0,i.kt)("a",{parentName:"p",href:"/specification"},"specification"),"."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Action")),(0,i.kt)("p",null,"The second field with the value ",(0,i.kt)("inlineCode",{parentName:"p"},"0")," indicates the ",(0,i.kt)("em",{parentName:"p"},"action")," of this operation. ",(0,i.kt)("inlineCode",{parentName:"p"},"0")," stands for CREATE, ",(0,i.kt)("inlineCode",{parentName:"p"},"1")," would stand for UPDATE and ",(0,i.kt)("inlineCode",{parentName:"p"},"2")," for DELETE. You can read more about operations in the ",(0,i.kt)("a",{parentName:"p",href:"/learn/operations"},"learn")," section or the ",(0,i.kt)("a",{parentName:"p",href:"/specification/data-types/operations"},"specification")," but for now it is enough to understand that with these three actions we can create, update or delete ",(0,i.kt)("em",{parentName:"p"},"documents"),"."),(0,i.kt)("p",null,"In this particular case we're creating a new ",(0,i.kt)("em",{parentName:"p"},"schema field")," document, the one containing the ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," field! This is why the action is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"0"),"."),(0,i.kt)("admonition",{title:"Why these numbers?",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"We could have also written ",(0,i.kt)("inlineCode",{parentName:"p"},"create"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"update"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"delete")," instead of these weird numbers, but then we realised that at one point you will send hundreds of operations, so it becomes quite redundant to mention this so explicitly. We decided to encode actions as numbers, simply to save some bytes!")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Schema Id")),(0,i.kt)("p",null,"The third field with the value ",(0,i.kt)("inlineCode",{parentName:"p"},"schema_field_definition_v1")," is the ",(0,i.kt)("em",{parentName:"p"},"schema id"),". This identifier indicates which schema we're following with this operation. Together with the ",(0,i.kt)("em",{parentName:"p"},"action"),' we can say now: "I\'m creating a new schema field document!". We know this because the ',(0,i.kt)("em",{parentName:"p"},"action")," is a CREATE action and the schema id says that we're interested in a schema field."),(0,i.kt)("p",null,"You will see later that there are other schema ids as well, and by creating a ",(0,i.kt)("inlineCode",{parentName:"p"},"chat")," schema we will even create our own! Other developers will later use your created schema id to indicate that they want to create documents with it!"),(0,i.kt)("admonition",{title:"System vs. application schemas",type:"note"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"schema_field_definition_v1")," is a ",(0,i.kt)("em",{parentName:"p"},"system")," schema which means that it is already registered by default on every node which follows the ",(0,i.kt)("a",{parentName:"p",href:"/specification/data-types/schemas"},"p2panda specification"),". Our ",(0,i.kt)("inlineCode",{parentName:"p"},"chat")," schema will be an ",(0,i.kt)("em",{parentName:"p"},"application")," schema, it is not used for special p2panda cases like creating a new schema but for building a chat application!")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Fields")),(0,i.kt)("p",null,"The last and fourth field is probably the most interesting one, it contains the actual data we want to send: The operation ",(0,i.kt)("em",{parentName:"p"},"fields")," with all our ",(0,i.kt)("em",{parentName:"p"},"values"),"! You see, it is a simple key-value map where we're setting two fields:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"name")," is set to ",(0,i.kt)("inlineCode",{parentName:"li"},"message")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"type")," is set to ",(0,i.kt)("inlineCode",{parentName:"li"},"str"))),(0,i.kt)("p",null,"First of all, where does ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"type")," come from? It comes from the defined ",(0,i.kt)("em",{parentName:"p"},"schema id")," ",(0,i.kt)("inlineCode",{parentName:"p"},"schema_field_definition_v1")," which is a system schema ",(0,i.kt)("em",{parentName:"p"},"requiring")," us to fill out these fields by specification: Every schema field ",(0,i.kt)("em",{parentName:"p"},"needs")," a ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," and a ",(0,i.kt)("inlineCode",{parentName:"p"},"type"),"."),(0,i.kt)("admonition",{title:"Try to break it!",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"You can try to send a ",(0,i.kt)("inlineCode",{parentName:"p"},"schema_field_definition_v1")," with missing or wrong fields inside, you will see, it will not be accepted by the ",(0,i.kt)("inlineCode",{parentName:"p"},"aquadoggo")," node.")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," field indicates what the name of our future schema field should be and we decided it should be ",(0,i.kt)("inlineCode",{parentName:"p"},"message"),". You can put in anything else here if you want to come up with a different schema, just make sure it follows the ",(0,i.kt)("a",{parentName:"p",href:"/specification/data-types/schemas"},"naming rules"),"."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"type")," field indicates what type this ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," field should have. We can pick a couple of options here, but ",(0,i.kt)("inlineCode",{parentName:"p"},"str")," is probably what we want. Otherwise there is:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"int"),", which is an integer number (",(0,i.kt)("inlineCode",{parentName:"li"},"i64"),"), like ",(0,i.kt)("inlineCode",{parentName:"li"},"54")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"-21")," ranging from ",(0,i.kt)("inlineCode",{parentName:"li"},"-9223372036854775808")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"9223372036854775807"),", hui!"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"float"),", which is a float number (",(0,i.kt)("inlineCode",{parentName:"li"},"f64"),"), like ",(0,i.kt)("inlineCode",{parentName:"li"},"23.98")," ranging from ",(0,i.kt)("inlineCode",{parentName:"li"},"-1.7976931348623157E+308f64")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"1.7976931348623157E+308f64"),", oha!"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"bool"),", which can be ",(0,i.kt)("inlineCode",{parentName:"li"},"true")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"false")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"str"),", which can be any sort of text, for example a chat message!")),(0,i.kt)("p",null,".. and now it gets interesting, there is even more:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"relation"),", which can be a reference to another document! Woah."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"relation_list"),", which can be a list of references to many documents!"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"pinned_relation"),", which can be a reference to a ",(0,i.kt)("em",{parentName:"li"},"document view"),". This is a document in a past, historical version. Like an ",(0,i.kt)("em",{parentName:"li"},"archived")," version you wanted to keep. So cool."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"pinned_relation_list"),", which is a list of document views! \ud83e\udd2f")),(0,i.kt)("admonition",{title:"Why do we need relations?",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Relations are really handy if you want to connect one document to another, even across different schemas. For example you might want to connect every ",(0,i.kt)("inlineCode",{parentName:"p"},"chat")," message to a user ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," document, then you would first create a new ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," schema, and indicate in ",(0,i.kt)("inlineCode",{parentName:"p"},"chat")," that there is now a ",(0,i.kt)("inlineCode",{parentName:"p"},"relation")," to it!")),(0,i.kt)("p",null,"We will not use any relations in this tutorial, but if you're curious you can read more about them in the ",(0,i.kt)("a",{parentName:"p",href:"/learn/operations"},"learn section"),"."),(0,i.kt)("h4",{id:"send-to-node"},"Send to node"),(0,i.kt)("p",null,"Okay, we looked now at what this whole operation is about! Let's send it finally to the node! Make sure it is all up and running."),(0,i.kt)("p",null,"We send the operation with ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," by simply ",(0,i.kt)("em",{parentName:"p"},"piping")," it into the ",(0,i.kt)("inlineCode",{parentName:"p"},"stdin")," input of the program, like that:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cat 001-message-field.json | cargo run\n")),(0,i.kt)("p",null,"As already mentioned above, this will now encode the operation into the right format, wrap it into a ",(0,i.kt)("a",{parentName:"p",href:"/learn/entries"},"Bamboo entry"),", append it to the Bamboo log, sign it with your new key pair and send it to the node."),(0,i.kt)("p",null,"If everything went fine we should see something similar like this now:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\u25b6 Public Key: "b129339f1264614a7c6b62cc20f9bfa21a0763a5198db82d85ae9c8543578f10"\n\u25b6 Operation Id: "0020f7be169cacc814b21526e018ad3cb423c93b215b5bd4901146b6bed1b1c4560e"\n\nWoho! \u30fd(\uffe3(\uff74)\uffe3)\uff89\n')),(0,i.kt)("p",null,"First we see the ",(0,i.kt)("em",{parentName:"p"},"Public Key")," of our key pair. It will be different for you since these keys are securely and randomly generated. Your key will be unique! You can probably find the private part in the file now which has been generated for you by ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," when running it for the first time, have a look at it via ",(0,i.kt)("inlineCode",{parentName:"p"},"less ./key.txt"),"."),(0,i.kt)("p",null,"The second ",(0,i.kt)("em",{parentName:"p"},"Operation Id")," is the identifier of the operation we've just created! In this case it was even a CREATE operation which means that we've just created a new document and that means that the document id will be the same. So now we could say: \"I've created a ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," field and its document id is ",(0,i.kt)("inlineCode",{parentName:"p"},"0020f7be169..."),'". This hash of course will also be different from mine since it is all a combination of your key pair, created entry and operation and this is also ',(0,i.kt)("em",{parentName:"p"},"unique"),"."),(0,i.kt)("p",null,"This also means that ",(0,i.kt)("em",{parentName:"p"},"every")," operation, document and schema you create ",(0,i.kt)("em",{parentName:"p"},"is")," unique! Even when you would create the field again, it will have a different identifier."),(0,i.kt)("p",null,"Let's remember this operation id for now, we need it later. Ah, of course its too long to remember, maybe you paste it quickly into a text document or something?"),(0,i.kt)("admonition",{title:"Sensitive data",type:"info"},(0,i.kt)("p",{parentName:"admonition"},"Private keys are sensitive information which should never leave your computer, usually you want to keep them somewhere in a well protected place. For this tutorial it may not be that important though, you could delete that file again and generate a new one if you want. If you keep the file ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," will re-use it next time which is cool. "),(0,i.kt)("p",{parentName:"admonition"},"By the way, in p2panda it is important to have ",(0,i.kt)("a",{parentName:"p",href:"/specification/data-types/key-pairs"},"multiple keys")," for different applications, purposes or devices.")),(0,i.kt)("h4",{id:"query-the-field"},"Query the field"),(0,i.kt)("p",null,"We've created a new field now, so we can also directly inspect it via the GraphQL playground of the ",(0,i.kt)("inlineCode",{parentName:"p"},"aquadoggo")," node. For this you can just surf to ",(0,i.kt)("a",{parentName:"p",href:"http://localhost:2020/graphql"},"http://localhost:2020/graphql")," and run the following query in the left area:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"{\n  all_schema_field_definition_v1 {\n    meta {\n      documentId\n    }\n    fields {\n      name\n      type\n    }\n  }\n}\n")),(0,i.kt)("p",null,"Press the ",(0,i.kt)("em",{parentName:"p"},"Play")," button in the middle and you will see the node's response appear in the right area. Here is the field document we've just created! And if you compare your ",(0,i.kt)("em",{parentName:"p"},"Operation Id")," with the ",(0,i.kt)("inlineCode",{parentName:"p"},"documentId")," you will see that they are the same."),(0,i.kt)("h3",{id:"create-timestamp-field"},"Create ",(0,i.kt)("inlineCode",{parentName:"h3"},"timestamp")," field"),(0,i.kt)("p",null,"We looked into many details now when we've created that ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," field. This time we're doing something very similar, so we don't need to talk about anything new."),(0,i.kt)("p",null,"Let's create a second file, named ",(0,i.kt)("inlineCode",{parentName:"p"},"002-timestamp-field.json")," with the following content:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[1, 0, "schema_field_definition_v1", { "name": "timestamp", "type": "int" }]\n')),(0,i.kt)("p",null,"It looks almost the same, just has a different ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"type"),". This time we choose an integer type because we want our timestamp to be a regular ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Unix_time"},"Unix time number"),"."),(0,i.kt)("p",null,"We create a new field document by sending this operation as well to the node:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cat 002-timestamp-field.json | cargo run\n")),(0,i.kt)("p",null,"You will get a similar output again when everything went fine. Keep a note of the ",(0,i.kt)("em",{parentName:"p"},"Operation Id")," for this field, we need it in the next step."),(0,i.kt)("p",null,"Also, if you are curious, you can run the GraphQL query again and find out that there are two field documents now on your node."),(0,i.kt)("h3",{id:"create-chat-schema"},"Create ",(0,i.kt)("inlineCode",{parentName:"h3"},"chat")," schema"),(0,i.kt)("p",null,"Finally we want to create the actual schema! Here we define the ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," of the schema, give it a small ",(0,i.kt)("inlineCode",{parentName:"p"},"description")," and refer to the ",(0,i.kt)("inlineCode",{parentName:"p"},"fields")," we've created before."),(0,i.kt)("admonition",{title:"Tedious work?",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"We need to send three operations to create a schema, this is so much work! But remember, we're doing it with a very minimal ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," tool right now for the purpose of learning how it works ",(0,i.kt)("em",{parentName:"p"},"under the hood")," or ",(0,i.kt)("em",{parentName:"p"},"behind the scenes")," and so on."),(0,i.kt)("p",{parentName:"admonition"},"Later there will be tools like ",(0,i.kt)("inlineCode",{parentName:"p"},"fishyfish")," to create schemas in one step, they handle all of these requests automatically for you. Or you can write your own tool or scripts of course using the p2panda ",(0,i.kt)("a",{parentName:"p",href:"/libraries"},"libraries"),".")),(0,i.kt)("p",null,"We do this again by creating a new document named ",(0,i.kt)("inlineCode",{parentName:"p"},"003-chat-schema.json")," with the following operation inside:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[\n  1,\n  0,\n  "schema_definition_v1",\n  {\n    "description": "My first p2panda chat schema",\n    "fields": [\n      ["<insert your `message` document id here>"],\n      ["<insert your `timestamp` document id here>"]\n    ],\n    "name": "chat"\n  }\n]\n')),(0,i.kt)("p",null,"This looks slightly different from the previous operations we were sending, but a couple of things are the same: We're again sending a CREATE operation, but this time using the ",(0,i.kt)("inlineCode",{parentName:"p"},"schema_definition_v1")," schema id which requires us to fill out the three fields: ",(0,i.kt)("inlineCode",{parentName:"p"},"description"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"fields")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"name"),"."),(0,i.kt)("admonition",{title:"Ordering of the fields",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"You would probably like to start with ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," as the first field, right? The ordering of the field names ",(0,i.kt)("em",{parentName:"p"},"needs")," to be alphabetical though. You can try a different order, but the ",(0,i.kt)("inlineCode",{parentName:"p"},"aquadoggo")," will reject it with a friendly error message telling you what order it expected the fields to be."),(0,i.kt)("p",{parentName:"admonition"},"All of this is required to ensure an ",(0,i.kt)("a",{parentName:"p",href:"/specification/encoding-data"},"canonical encoding")," of operations.")),(0,i.kt)("p",null,"Did you keep track of the document id's of your ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"timestamp")," documents somewhere? Insert them in the placeholders in the .json file. If you don't have them anymore, you can also check the GraphQL playground using the same query we already tried before. It will give you the ",(0,i.kt)("inlineCode",{parentName:"p"},"documentId")," of the two fields."),(0,i.kt)("p",null,"My ",(0,i.kt)("inlineCode",{parentName:"p"},"fields")," looks like this now, yours should be similar, just with different hashes:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'"fields": [\n  ["0020f7be169cacc814b21526e018ad3cb423c93b215b5bd4901146b6bed1b1c4560e"],\n  ["002074ffa5d2e9e5c721483cad91cdfd8ebbd3ac1e716831ff5934becc83f5e13329"]\n]\n')),(0,i.kt)("admonition",{title:"Pinned relations and schema migrations",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"fields")," look funny with their nested array structure, did you notice that? You're using a pinned relation here actually, which means that we're pointing our ",(0,i.kt)("inlineCode",{parentName:"p"},"chat")," schema at ",(0,i.kt)("em",{parentName:"p"},"exactly")," these versions of our fields."),(0,i.kt)("p",{parentName:"admonition"},"Since a document version can consist of multiple, concurrent operations we have a multi-dimensional array here, to give us the option to address more than one operation expressing our ",(0,i.kt)("em",{parentName:"p"},"view"),". Concurrent operations can happen if multiple users update the document at the same time! We usually don't have to worry much about it though, as all of this is handled by p2panda, but it might be interesting to know for you what is going on here."),(0,i.kt)("p",{parentName:"admonition"},"Currently there is only one view id since you've just created the fields, but imagine you will update your fields in the future. That might break something for some users as suddenly the name of the field changed etc. To prevent this, we're pinning everything to a historical state, so there are no surprises."),(0,i.kt)("p",{parentName:"admonition"},"Of course the users can still follow your update, but then they have to use the new schema id. Isn't that cool? We get ",(0,i.kt)("strong",{parentName:"p"},"schema migrations")," for free.")),(0,i.kt)("p",null,"We send this operation again to our node via:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cat 003-chat-schema.json | cargo run\n")),(0,i.kt)("p",null,"And now it gets exciting! Let's open the playground and have a look into the ",(0,i.kt)("em",{parentName:"p"},"Docs")," tab on the right hand side. There it is! Our new ",(0,i.kt)("inlineCode",{parentName:"p"},"chat")," schema!"),(0,i.kt)("admonition",{title:"Huh, I don't see anything?",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Oh, maybe you should refresh the page then (the playground's auto-refresh can be turned on / off). If it still doesn't work you might have used the wrong hashes? Double check it! I hope you didn't use the ones from my example, because your hashes will surely be different!")),(0,i.kt)("p",null,"We can even query that schema now, you just need to insert your schema id before (you'll find it in the ",(0,i.kt)("em",{parentName:"p"},"Docs")," tab, or just use the autocomplete feature of the Playground):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"{\n  all_<insert your schema id here> {\n    fields {\n      message\n      timestamp\n    }\n  }\n}\n")),(0,i.kt)("p",null,"It will return an empty response. Of course, we haven't created a chat message yet, let's do it!"),(0,i.kt)("admonition",{title:"Curious polar bear",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Did you have a peek at the logs of your ",(0,i.kt)("inlineCode",{parentName:"p"},"aquadoggo"),"?")),(0,i.kt)("h2",{id:"create-a-new-chat-message"},"Create a new chat message!"),(0,i.kt)("p",null,"We create our first document using the application schema we've just created. For this we need it's ",(0,i.kt)("em",{parentName:"p"},"Schema Id"),", we should have already checked it in the steps before, if not, please have a look in the Playground, you'll find it in the ",(0,i.kt)("em",{parentName:"p"},"Docs")," tab on the right hand side."),(0,i.kt)("p",null,"Use this schema id to write your first CREATE operation, again we need a new file ",(0,i.kt)("inlineCode",{parentName:"p"},"004-create-message.json")," for this with the following content:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[\n  1,\n  0,\n  "<insert your schema id here>",\n  {\n    "message": "Hello, Panda!",\n    "timestamp": 1662459998\n  }\n]\n')),(0,i.kt)("p",null,"Just replace the schema id with your own and send the operation via:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cat 004-create-message.json | cargo run\n")),(0,i.kt)("p",null,"Woho! Have a look in the GraphQL playground, you can query your chat message there now."),(0,i.kt)("h2",{id:"update-chat-message"},"Update chat message"),(0,i.kt)("p",null,"We are building a special chat program where we can also edit our messages afterwards. Let's send an UPDATE operation to change the chat message document we've created in the step before."),(0,i.kt)("admonition",{title:"Show changes",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"If we want to build a ",(0,i.kt)("em",{parentName:"p"},"really cool")," chat application we could even show the history of edits with pinned relations.")),(0,i.kt)("p",null,"For this we're creating another file named ",(0,i.kt)("inlineCode",{parentName:"p"},"005-update-message.json")," with the following content:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[\n  1,\n  1,\n  "<insert your schema id here>",\n  ["<insert your view id here>"],\n  {\n    "message": "Good night, Panda!"\n  }\n]\n')),(0,i.kt)("p",null,"This looks again a little bit different now. UPDATE operations have the ",(0,i.kt)("inlineCode",{parentName:"p"},"action")," field set to ",(0,i.kt)("inlineCode",{parentName:"p"},"1")," as you can see and require us to specify a ",(0,i.kt)("inlineCode",{parentName:"p"},"previous")," field. It indicates where we are planning to apply the update."),(0,i.kt)("admonition",{title:"Operation graphs",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"previous")," field is really powerful. Imagine many users applying updates to a document at the same time, with the ",(0,i.kt)("inlineCode",{parentName:"p"},"previous")," field we are able to understand what all of these users meant when they wanted to apply their changes. Not every user might have seen the same as the others, for example one user might have been offline and worked on a slightly ",(0,i.kt)("em",{parentName:"p"},"outdated")," version of the document, another one was writing right after another user and did not take that change into account yet and so on."),(0,i.kt)("p",{parentName:"admonition"},"With the help of the ",(0,i.kt)("inlineCode",{parentName:"p"},"previous")," field we can build a whole ",(0,i.kt)("em",{parentName:"p"},"Operation Graph")," of all changes which have been applied to a document and try to reconstruct one document version of it, even though the changes might have been made concurrently.")),(0,i.kt)("p",null,"Another thing to note here is that we do not have to mention ",(0,i.kt)("em",{parentName:"p"},"all")," fields of our ",(0,i.kt)("inlineCode",{parentName:"p"},"chat")," schema, but only the ones we want to update, in this case it is the ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," field."),(0,i.kt)("p",null,"We're already having the schema id and we can insert it into ",(0,i.kt)("inlineCode",{parentName:"p"},"005-update-message.json")," but where do we get that ",(0,i.kt)("em",{parentName:"p"},"view id")," from? It is basically the last known version of that document we want to apply the changes on, we also call this a ",(0,i.kt)("a",{parentName:"p",href:"/specification/data-types/document-views"},(0,i.kt)("em",{parentName:"a"},"Document View Id")),"."),(0,i.kt)("p",null,"Again, the GraphQL playground can help us here. We can simply just query all chat messages and ask for their regarding ",(0,i.kt)("inlineCode",{parentName:"p"},"viewId")," with the following query:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"{\n  all_<insert your schema id here> {\n    meta {\n      documentId\n      viewId\n    }\n    fields {\n      message\n      timestamp\n    }\n  }\n}\n")),(0,i.kt)("p",null,"You might notice that the ",(0,i.kt)("inlineCode",{parentName:"p"},"viewId")," is actually currently the same as the ",(0,i.kt)("inlineCode",{parentName:"p"},"documentId"),", this is because there is ",(0,i.kt)("em",{parentName:"p"},"only")," one version of this document right now. As soon as we apply some updates you will notice that the ",(0,i.kt)("inlineCode",{parentName:"p"},"documentId")," will stay the same, but the ",(0,i.kt)("inlineCode",{parentName:"p"},"viewId")," will evolve to something else."),(0,i.kt)("admonition",{title:"Latest document vs. document view",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"This is exactly the difference between a ",(0,i.kt)("em",{parentName:"p"},"document id")," and a ",(0,i.kt)("em",{parentName:"p"},"view id"),": The document id will always give you the ",(0,i.kt)("em",{parentName:"p"},"latest known")," version of a document, the data might change over time as soon as there are more updates coming. The ",(0,i.kt)("em",{parentName:"p"},"view id")," will give you a particular version which will never change ever. It is ",(0,i.kt)("em",{parentName:"p"},"immutable"),"."),(0,i.kt)("p",{parentName:"admonition"},"What is the ",(0,i.kt)("em",{parentName:"p"},"latest")," is up to the node, it might ",(0,i.kt)("em",{parentName:"p"},"think")," it knows the latest version, but actually it has not synced up yet with other nodes to really see the latest changes. But that's just how it is in a p2p network. Thanks to p2panda operations and ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type"},"CRDTs")," we don't need to worry about it too much.")),(0,i.kt)("p",null,"We have all informations now to finally send this update:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cat 005-update-message.json | cargo run\n")),(0,i.kt)("p",null,"Go back to the playground and re-play your query, you should see the latest version now and maybe even see that the ",(0,i.kt)("inlineCode",{parentName:"p"},"viewId")," changed!"),(0,i.kt)("h2",{id:"delete-chat-message"},"Delete chat message"),(0,i.kt)("p",null,"Last but not least we want to delete our chat message, just to also learn how to use DELETE operations."),(0,i.kt)("p",null,"This is our last JSON file named ",(0,i.kt)("inlineCode",{parentName:"p"},"006-delete-message.json"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[\n  1,\n  2,\n  "<insert your schema id here>",\n  ["<insert your last view id here>"]\n]\n')),(0,i.kt)("p",null,"Woah, no ",(0,i.kt)("em",{parentName:"p"},"fields"),"? Yes, we do not need them when we delete a document. Also you may have noticed that the ",(0,i.kt)("em",{parentName:"p"},"action")," field is now set to ",(0,i.kt)("inlineCode",{parentName:"p"},"2")," to indicate that this is a DELETE operation."),(0,i.kt)("p",null,"Similar to UPDATE operations we also need to set the ",(0,i.kt)("inlineCode",{parentName:"p"},"previous")," field again. We need to tell the ",(0,i.kt)("inlineCode",{parentName:"p"},"aquadoggo")," where we're applying that deletion. Again, we can get that information from the GraphQL playground, run the query again and retrieve the ",(0,i.kt)("inlineCode",{parentName:"p"},"viewId")," from there, it is the ",(0,i.kt)("em",{parentName:"p"},"latest known state")," from our node's perspective."),(0,i.kt)("p",null,"After running the ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," program via .."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cat 006-delete-message.json | cargo run\n")),(0,i.kt)("p",null,".. we should now get an empty response again in the GraphQL playground. There are no chat messages anymore!"),(0,i.kt)("admonition",{title:"Comparison with databases",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},'Think about it from the perspective of a "traditional" database. You probably need to specify the ID of the row or item you want to delete in the database.')),(0,i.kt)("h2",{id:"done"},"Done!"),(0,i.kt)("p",null,"Yay! Now you know how to create a schema and even documents with the ",(0,i.kt)("inlineCode",{parentName:"p"},"send-to-node")," tool. You could also write your own program which sends and signs the operations using the p2panda ",(0,i.kt)("a",{parentName:"p",href:"/libraries"},"libraries"),". Querying documents and publishing operations via GraphQL is basically everything a p2panda client is doing. In this tutorial we did it ",(0,i.kt)("em",{parentName:"p"},"manually")," but a client of course would do it all for us in the background."),(0,i.kt)("p",null,"Check out the ",(0,i.kt)("a",{parentName:"p",href:"/tutorials/mushroom-app"},"next tutorial")," on how to build a client in React if you're curious about how to actually do this."))}h.isMDXComponent=!0}}]);